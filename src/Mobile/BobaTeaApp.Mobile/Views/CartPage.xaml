<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:controls="clr-namespace:BobaTeaApp.Mobile.Controls"
             x:Class="BobaTeaApp.Mobile.Views.CartPage"
             Title="Cart">

    <Grid>
        <!-- Main Content -->
        <ScrollView>
            <VerticalStackLayout Padding="16" Spacing="16">

                <!-- Cart Items -->
                <CollectionView ItemsSource="{Binding Items}"
                              SelectionMode="None"
                              IsVisible="{Binding IsEmpty, Converter={StaticResource InvertedBoolConverter}}">
                    <CollectionView.ItemTemplate>
                        <DataTemplate>
                            <Frame Margin="0,0,0,12"
                                 Padding="16"
                                 BackgroundColor="White"
                                 CornerRadius="12"
                                 HasShadow="True">

                                <Grid ColumnDefinitions="*,Auto" RowDefinitions="Auto,Auto,Auto" ColumnSpacing="12">

                                    <!-- Product Name -->
                                    <Label Grid.Row="0" Grid.Column="0"
                                         Text="{Binding Name}"
                                         FontSize="16"
                                         FontAttributes="Bold"
                                         TextColor="{StaticResource Gray900}"/>

                                    <!-- Customizations -->
                                    <Label Grid.Row="1" Grid.Column="0"
                                         FontSize="12"
                                         TextColor="{StaticResource Gray600}">
                                        <Label.FormattedText>
                                            <FormattedString>
                                                <Span Text="{Binding SizeOption}" />
                                                <Span Text=" â€¢ " />
                                                <Span Text="{Binding SweetnessLevel}" />
                                                <Span Text=" â€¢ " />
                                                <Span Text="{Binding IceLevel}" />
                                            </FormattedString>
                                        </Label.FormattedText>
                                    </Label>

                                    <!-- Price -->
                                    <Label Grid.Row="2" Grid.Column="0"
                                         Text="{Binding LineTotal, StringFormat='${0:F2}'}"
                                         FontSize="18"
                                         FontAttributes="Bold"
                                         TextColor="{StaticResource Primary}"/>

                                    <!-- Quantity Controls -->
                                    <VerticalStackLayout Grid.Row="0" Grid.RowSpan="3" Grid.Column="1"
                                                       Spacing="8"
                                                       VerticalOptions="Center">

                                        <HorizontalStackLayout Spacing="8">
                                            <Button Text="-"
                                                  Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.DecrementCommand}"
                                                  CommandParameter="{Binding .}"
                                                  WidthRequest="40"
                                                  HeightRequest="40"
                                                  CornerRadius="20"
                                                  BackgroundColor="{StaticResource Gray200}"/>

                                            <Label Text="{Binding Quantity}"
                                                 FontSize="16"
                                                 FontAttributes="Bold"
                                                 VerticalOptions="Center"
                                                 WidthRequest="30"
                                                 HorizontalTextAlignment="Center"/>

                                            <Button Text="+"
                                                  Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.IncrementCommand}"
                                                  CommandParameter="{Binding .}"
                                                  WidthRequest="40"
                                                  HeightRequest="40"
                                                  CornerRadius="20"
                                                  BackgroundColor="{StaticResource Primary}"/>
                                        </HorizontalStackLayout>

                                        <Button Text="Remove"
                                              Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.RemoveCommand}"
                                              CommandParameter="{Binding .}"
                                              FontSize="12"
                                              TextColor="{StaticResource Danger}"
                                              BackgroundColor="Transparent"
                                              BorderColor="Transparent"/>

                                    </VerticalStackLayout>

                                </Grid>
                            </Frame>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>

                <!-- Subtotal and Checkout (only when cart has items) -->
                <VerticalStackLayout Spacing="16"
                                   IsVisible="{Binding IsEmpty, Converter={StaticResource InvertedBoolConverter}}">

                    <BoxView HeightRequest="1" Color="{StaticResource Gray200}"/>

                    <Grid ColumnDefinitions="*,Auto" Padding="0">
                        <Label Text="Subtotal"
                             FontSize="18"
                             FontAttributes="Bold"
                             TextColor="{StaticResource Gray900}"/>
                        <Label Grid.Column="1"
                             Text="{Binding Subtotal, StringFormat='${0:F2}'}"
                             FontSize="20"
                             FontAttributes="Bold"
                             TextColor="{StaticResource Primary}"/>
                    </Grid>

                    <Button Text="Proceed to Checkout"
                          Command="{Binding NavigateCheckoutCommand}"
                          BackgroundColor="{StaticResource Primary}"
                          TextColor="White"
                          HeightRequest="56"
                          CornerRadius="12"
                          FontSize="16"
                          FontAttributes="Bold"/>
                </VerticalStackLayout>

            </VerticalStackLayout>
        </ScrollView>

        <!-- Empty State -->
        <controls:EmptyStateView IsVisible="{Binding IsEmpty}"
                               Icon="ðŸ›’"
                               Title="Your cart is empty"
                               Message="Browse our menu and add your favorite drinks to get started!"
                               ActionText="Browse Menu"
                               ActionCommand="{Binding NavigateToMenuCommand}"/>

        <!-- Loading Overlay -->
        <controls:LoadingOverlay IsLoading="{Binding IsBusy}"
                               LoadingText="{Binding LoadingText}"/>
    </Grid>

</ContentPage>
